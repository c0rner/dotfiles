#!/bin/bash
Interval=${1:-0.2}

sum() {
	local -i sum=0
	local -i val
	for val in $*; do
		sum=$((sum + val))
	done
	echo $sum
}

percentage() {
	[[ $2 -eq 0 ]] && { echo 0; return; }
	echo $((($1 * 100) / $2))
}

graph() {
	local -i val=$(($1 / 12))
	set ▁ ▂ ▃ ▄ ▅ ▆ ▇ █ █
	while [ $val -gt 0 ]; do shift; val=$((val - 1)); done
	echo -n "$1"
}

cpustat() {
	read < /proc/stat
	echo ${REPLY}
}

typeset -i Total
typeset -i Ototal
typeset -i Idle
typeset -i Oidle
typeset -i Cols=50
typeset -i Width

while true; do
	set -- $(cpustat)
	shift
	Total=$(sum $*)
	Idle=$4
	graph $((100 - $(percentage $((Idle - Oidle)) $((Total - Ototal)))))
	Ototal=${Total}
	Oidle=${Idle}
	Width=$((Width + 1))
	if [ ${Width} -ge ${Cols} ]; then
		echo " $(date)"
		Width=0
	fi
	sleep ${Interval}
done
